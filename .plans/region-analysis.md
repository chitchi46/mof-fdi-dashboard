# 地域セグメント分析

## 目的（Goal）
- 地域/エリア情報を `segment_region` に正規化し、ダッシュボードで一次フィルタ/次元として扱えるようにして、全ビューで地域比較（単一/複数）を可能にする。

## 範囲（Scope）
- 正準の地域辞書（JP/EN別名、ISOコード、グルーピング）を作成し版管理する。
- 正規化で地域列/ヘッダー/脚注を検出して `segment_region` を付与する。
- サマリ構造とAPIを地域スライスに対応させる。
- すべてのチャートに地域マルチセレクトと地域対応の凡例/ラベルを追加。
- ドキュメント/パースログ/テストを更新。
- 対象外: 辞書範囲を超える国レベルの深掘り、UIの国際化。

## 成果物（Deliverables）
- `src/mof_investviz/normalize.py`: 地域抽出ロジックと単体テスト。
- 地域辞書アセット（例: `data/dictionaries/regions.yml`）と版情報。
- 地域でグルーピング可能なサマリビルダー（必要なら新ヘルパーモジュール）。
- ダッシュボードUI強化（地域マルチセレクト、フィルタ表示、状態保持）。
- ワークフロー記載のDocs（README、docs/README、USAGE）。
- 地域正規化＋UIスモークの自動テスト（Playwright 等）。

## 作業分解（Work Breakdown）
1. 調査と辞書
   - サンプルから地域ラベルを収集し、頻用パターン（漢字/カナ/英語）を分類。
   - 正準キー（ISO2/3、国内グループ等）を定義して `regions.yml`＋スキーマを作成。
   - 未知地域のフォールバック方針（`Unknown`/`Other`）。
2. 正規化強化
   - 地域情報に相当する列/ヘッダー/脚注を特定（正規表現、ヘッダー規則）。
   - 正規化地域ID＋表示名を返すパーサを実装。
   - `NormalizeResult.meta` に検出カバレッジを記録。
   - 曖昧ケースを含むフィクスチャで単体テスト追加。
3. サマリ/集計層
   - `aggregate_by_region` 等を導入（地域別時系列/構成比/ヒートマップ）。
   - 既存 `summary.json` との後方互換を確保（必要時は版上げ）。
4. ダッシュボードUX
   - 検索付きマルチセレクト、「すべて選択」、URLハッシュ/LocalStorageへ保存。
   - すべてのビューが地域選択を尊重（積み上げ/オーバーレイ、地域ごとの色キー）。
   - アクティブフィルタを示すチップとリセット。
5. Docsとログ
   - `docs/README.md` と `docs/USAGE.md` にワークフロー（アップロード/フィルタ/地域別DL）を記載。
   - `parse_log.json` に地域検出の要約を追加。
6. 検証
   - 地域フィルタが出力に反映されることを、単体/結合で回帰テスト。
   - 手動QA（既知データでマルチセレクト、CSVがフィルタ整合）。

## 依存関係（Dependencies）
- 地域辞書アセットと分類体系の合意。
- CSVエクスポートは地域フィルタに整合（`.plans/dashboard-csv-export.md` と連携）。

## リスクと対策（Risks & Mitigations）
- 曖昧ラベル（例: 「アジア計」）→ 別名表＋重み付け、未解決はログ。
- 多地域スライス時の性能低下 → 事前集計、UIのデバウンス。
- 既存summary利用者との互換 → スキーマ版上げ、地域次元無し時の既定値提供。

## 未決事項（Open Questions）
- 階層地域（大陸→下位地域）の初期対応の要否。
- 未知地域は既定で表示/非表示どちらか。
- UIとして同時選択可能な地域数の上限。

## 受け入れ基準（Acceptance Criteria）
- 地域情報を含むデータで `segment_region` 正答率 ≥95%。
- ダッシュボードが全ビュー/CSVで地域フィルタを反映。
- Docs が新ワークフローを反映し、辞書＋UIの自動テストが存在。
