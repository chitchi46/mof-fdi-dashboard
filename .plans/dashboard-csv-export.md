# ダッシュボードのCSVエクスポート刷新

## 目的（Goal）
- 現在のダッシュボード状態（フィルタ/選択ビュー/系列範囲）を反映したCSVを、低遅延でダウンロードできるようにする。

## 範囲（Scope）
- ビュー別のエクスポートAPI設計（時系列、前年比差分、構成比、ヒートマップ行列、箱ひげ統計）。
- アクティブなフィルタに連動するUI（エクスポートメニュー/ボタン、進行表示）。
- 大規模データ向けにサーバ側でキャッシュ/ストリーミングを実装。
- エクスポート形式のドキュメントとテストを整備。
- 対象外: PDF/画像エクスポート、定期配信。

## 成果物（Deliverables）
- `/api/export` エンドポイント（`type`/`filters`/`format`/`locale` を受け付け）。
- 集計ユーティリティを再利用するエクスポートサービス層（ダッシュボードと単一路線）。
- ビューごとの既定と詳細オプションを持つUIコントロール。
- `docs/USAGE.md` にCSVスキーマ（列説明・単位・サンプル行）。
- 各エクスポート種別の単体/結合テスト。

## 作業分解（Work Breakdown）
1. 要件・フォーマット定義（統合メニュー対応）
   - 必要なエクスポート種別と列スキーマを定義。
   - 命名規約（snake_case, 単位）を `schema.yaml` に合わせる。
   - 圧縮の要否（複数ファイル時の `.zip`）。
2. バックエンド実装（既存API再利用）
   - 集計ロジックを専用モジュールへリファクタし再利用。
   - フィルタ適用（side/metric/region/year/measure）込みのCSVシリアライズ（必要に応じストリーミング）。
   - 入力＋フィルタのハッシュでキャッシュし再計算を回避。エラー/タイムアウト堅牢化、監査ログ（`parse_log.json` 等）。
3. フロント統合（ExportMenu）
   - エクスポートUIを単一メニューに統合（現ビューCSV/正規化/ピボット/PNG）。
   - クリックイベントを1本化、デリゲーションで各メニューに分岐。
   - 長時間ダウンロードのスピナー/トースト、データ無し時の無効化。
   - ファイル名にデータセット＋フィルタを符号化（例: `investviz_timeseries_assets_asia_2010-2024.csv`）。
4. 文書・サンプル
   - `docs/USAGE.md` にビュー→出力の対応表、サンプルコマンド。
   - `examples/` に出力例を置き回帰検証に利用。
5. テスト/回帰
   - シリアライズの単体、`/api/export` の結合、UIからのE2E（Playwright）。
   - ボタン重複や無反応が再発しないこと（単一/マルチパネル）。

## 依存関係（Dependencies）
- 地域フィルタ（`.plans/region-analysis.md`）。
- 集計の改良（`.plans/normalization-enhancements.md`）。

## リスクと対策（Risks & Mitigations）
- 大容量でサーバが詰まる → ストリーミング、行数上限、ユーザ警告。
- UIとAPIでフィルタ不整合 → フィルタ状態の集中シリアライズ（クエリハッシュ等）。
- CSVスキーマのドリフト → 種別ごとのバージョンと自動契約テスト。

## 未決事項（Open Questions）
- マルチタブ（指標別）zipが必要か。
- 出力にメタ（ソース/フィルタ）をコメントとして含めるか。
- CSV以外（TSV/Parquet/JSON）対応の要否。

## 受け入れ基準（Acceptance Criteria）
- サンプル条件で5秒未満でダウンロード可能。
- スキーマは文書化されテストで担保。
- 既存の正規化出力に回帰がない（ベースラインCSVは従来通り生成）。
