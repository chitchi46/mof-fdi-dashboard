# 基本操作（最小パイプラインとダッシュボード）

このドキュメントは、最小パイプライン（正規化 → サマリ生成 → ダッシュボード生成）とローカル表示の手順を示します。追加の外部依存は不要です（標準ライブラリのみ）。

---

## 1. 正規化パイプラインの実行

- 入力（単一 CSV または CSV ディレクトリ）を指定し、`build/` に成果物を出力します。

```
# WSL (bash) 例
python3 scripts/run_pipeline.py --input data --build-dir build
```

生成物:
- `build/normalized.csv`（tidy 形式, schema 準拠）
- `build/summary.json`（複数系列・3ビュー用のサマリ）
- `build/parse_log.json`（処理ログと統計）
- `build/schema.yaml`（スキーマのコピー）
- `build/index.html`（ダッシュボードの HTML）
- `build/pivot_year_measure.csv`（年×系列のピボット表。表計算での分析向け）

注意:
- 本 MVP では、値の単位を「億円（100m yen）」と仮置きしています。実データに合わせて `scale_factor` を適切に設定してください。
- 年次列はヘッダ名（year/年度/西暦 等）または 4 桁数値の多寡で推定します。

---

## 2. ダッシュボードの表示（ローカル）

```
# WSL (bash) 例: Windows からのアクセスも考慮して 0.0.0.0 で待受
python3 scripts/serve_dashboard.py --build-dir build --host 0.0.0.0 --port 8000
```

接続確認（WSL 内）:
- `curl -I http://127.0.0.1:8000/` が 200 を返すこと
- Windows 側のブラウザから `http://localhost:8000/` で表示（WSL2 のローカルホスト転送が有効な場合）
- 転送が無効な環境では、WSL 側の IP を使って `http://<WSL_IP>:8000/` を開く（`ip addr` などで確認）

- ブラウザで `http://127.0.0.1:8000` を開くと、アップロード UI が表示されます（ローカル CSV を投げ込むだけで可視化）。
- ビュー切替: 「時系列」「前年比差分」「構成比（最新年のシェア）」「ヒートマップ」「箱ひげ図」
- 系列選択: 上位 N（既定 5）measure から選択可能
- **地域フィルタ**: データに地域情報が含まれる場合、地域セレクトボックスが表示され、特定地域のデータを表示可能
- **CSVエクスポート**: 現在のビューとフィルタ設定に基づいて、絞り込まれたデータをCSVとしてダウンロード可能
- ダウンロード: 正規化済み `normalized.csv`、処理ログ `parse_log.json`、年×系列ピボット `pivot_year_measure.csv`

### 2.1 CSVエクスポート機能

ダッシュボード右上の「📥 CSVエクスポート」ボタンを使用すると、現在のビューとフィルタ設定に基づいて、絞り込まれたデータをCSVファイルとしてダウンロードできます。

**機能の特徴**:
- **フィルタ適用**: 地域フィルタで選択された地域のみのデータをエクスポート
- **年範囲適用**: 現在表示されている年範囲のデータのみを出力
- **ファイル名自動生成**: ビュー名、地域、年範囲に基づいて適切なファイル名を生成
  - 例: `investviz_timeseries_中華人民共和国_2014-2024.csv`
- **UTF-8 BOM付き**: Excel等の表計算ソフトで日本語が正しく表示されるよう、UTF-8 BOMを付加

**使用方法**:
1. ダッシュボードでビュー（時系列、前年比差分など）を選択
2. 地域フィルタで特定の地域を選択（任意）
3. 「📥 CSVエクスポート」ボタンをクリック
4. ブラウザのダウンロード機能でCSVファイルが保存される

**エクスポート可能なデータ**:
- 正規化済みのすべてのカラム（year, measure, segment_region, value_100m_yen など）
- フィルタ適用後の全レコード

### 2.2 地域別分析機能

データに地域情報（ヘッダーまたはセル値に地域名）が含まれる場合、自動的に地域が抽出され、フィルタとして利用可能になります。

**対応地域**:
- 主要地域: アジア、北米、中南米、欧州、オセアニア、中東、アフリカ
- 主要国: 中国、米国、英国、ドイツ、フランスなど（詳細は `data/dictionaries/regions.yml` を参照）
- 経済グループ: OECD、ASEAN、EU

**使い方**:
1. 地域情報を含むCSVファイルをアップロード
2. 「地域」セレクトボックスが自動表示される
3. 地域を選択すると、その地域のデータのみを表示
4. 「全地域」を選択すると全体のデータを表示

**注意**:
- 地域情報は `data/dictionaries/regions.yml` に定義された辞書に基づいて抽出されます
- 表記ゆれ（日本語・英語、略称など）に対応していますが、一部認識されない場合があります
- 地域辞書は随時拡張可能です
- 多層ヘッダーの解析により、6d-2のような複雑な地域別内訳データも正しく処理されます

**実績**:
- 6d-2.csv（対外直接投資の地域別内訳）: 41の地域・国を抽出
- 12年分（2014-2025）の地域別時系列データを生成
- ASEAN、EU、OECD諸国などの経済グループにも対応

**詳細**: ヘッダー解析の技術詳細は `docs/HEADER_PARSING.md` を参照してください

---

## 3. よくある調整ポイント

- `schema.yaml` の列定義/語彙（`metric`, `side`）を調整
- `normalize.py` の数値判定/年次推定ルールの閾値
- 将来のダッシュボード多系列/切替対応（`summary.json` を拡張）

---

## 4. ディレクトリ構成（追加）

- `src/mof_investviz/`：最小ロジック（IO/正規化/ダッシュボード）
- `scripts/`：実行スクリプト（パイプライン/サーバ）
- `schema.yaml`：正規化後のスキーマ定義（サンプル）
- `examples/parse_log.sample.json`：`parse_log.json` のサンプル
- `build/`：生成物出力先（Git 管理対象外推奨）

---

## 5. 次の一手（提案）

- `metric/side` 推定の強化（ファイル名・注釈多数決など）
- 単位検出と `scale_factor` 自動化（列名・注記から推定）
- 外れ値/ブレイク検知の実装と `qa_flag` 付与
- 地域セグメントの正規化とフィルタ UI（複数地域選択、年範囲スライダ）
- ビューごとの CSV エクスポート（現在のフィルタを反映）
- 描画品質改善（軸/配色/ツールチップ/凡例、高 DPI 対応）
- ダッシュボード多系列・指標切替、差分/構成比ビューの追加

---

## 6. 再起動（WSL/bash・手動）

開発中に素早く再起動したい場合は、WSL の bash で次を実行します（PowerShell は使用しません）。

```
cd /home/uka_agai/mof_investviz
bash scripts/wsl_restart_backend.sh 8002   # 8000にしたい場合は 8000 に変更
```

起動後は `http://127.0.0.1:<PORT>/` を開いてください。停止は `fuser -k -n tcp <PORT>`。

### 注意（重要）
- 本プロジェクトの起動・再起動・停止は、WSL(Ubuntu) の bash 前提です。
- どのような状況でも PowerShell 経由の実行は行わないでください。
