# 投資統計可視化システム — 要件定義書（改訂版）

本書は docs/README.md を UTF-8 で再作成した改訂版です。既存文書に発生していた文字化けを解消し、章立て・用語・スキーマを明確化しました。

## 1. 背景・目的
財務省が公表する「対外・対内直接投資統計」（例: 6d-1-1, 6d-2 CSV）は、和暦/西暦の混在、英日混在、多層ヘッダ、注釈行、単位の揺れなど、機械処理には不向きな特性を持つ。
これらを即時に正規化し、統合ダッシュボード上で可視化・探索できる仕組みを整備することで、業務利用者が全体像を迅速に把握し、意思決定に必要な深掘り分析を行えるようにする。

---

## 2. スコープ
- 入力: MOF 公表の CSV/Excel（和暦・西暦混在、英日混在、多層ヘッダ、注釈行を含む）
- 出力:
  - 正規化データ（縦持ち＝tidy 形式）
  - ダッシュボード（主要3ビュー: 時系列推移 / 前年差分 / 構成比）
  - 軽量分析（前年比・CAGR・信頼度フラグ・外れ値検知 など）

---

## 3. 成果物（Definition of Done）
- 任意の対象ファイル投入により以下を自動生成する:
  - 文字コード正規化済みの UTF-8 CSV
  - ダッシュボード（上記3ビュー以上）
  - 基礎分析（前年比・CAGR・信頼度の付与）
  - assets/liabilities が同時入力された場合は自動で統合ビューを生成
- 処理内容は `parse_log.json` に詳細記録し、同一入力＋設定からは同一出力（ビット等価）を得る。

---

## 4. データ要件

### 入力
- 文字コード: CP932, Shift_JIS, UTF-8, UTF-8-SIG を自動判定
- ファイルサイズ: 〜10MB（目安。30MB程度までの拡張余地）
- 欠損値: `--`, 空白, △, …, n.a., `*` を NaN/規定値に統一
- 和暦（昭和/平成/令和）→ 西暦変換に対応。辞書バージョンは `meta.era_dict_version` に保持
- カンマ区切り数値（例: "1,234"）の正規化、注釈行/脚注の除去

### 出力スキーマ（例）
```yaml
columns:
  - year: int              # 暦年
  - fiscal_year: int?      # 会計年度（必要に応じ）
  - year_jp: string        # 和暦表記
  - side: enum('assets','liabilities','unknown')
  - metric: enum('flow','reinvested','net','net_computed','unknown')
  - measure: string        # 多層ヘッダ連結（" / " 区切り）
  - segment_region: string?
  - segment_industry: string?
  - segment_other: string?
  - value_100m_yen: float  # 正規単位として「億円」に統一
  - qa_flag: string?
  - flag_outlier: bool?
  - flag_break: bool?
meta:
  - unit_original: string
  - scale_factor: float
  - rounding_policy: string
  - source_title: string
  - parse_log: json
```

補足:
- `metric` は内部表現に英小文字の列挙値を採用（UI で日本語/英語ラベルにマッピング）
- `side` は「assets = 対外」「liabilities = 対内」を基本とし、判定不能は `unknown`
- 値は原単位から `scale_factor` を用いて「億円」に正規化する

---

## 5. 機能要件

正規化処理
- 多層ヘッダの検出 → `measure` に連結
- `metric` の判定（原表ネット値と自算ネット値の区別を保持）
- `side` の判定（ファイル名・表題・注釈の多数決。不一致は `unknown`）
- 和暦/西暦、数値、単位、欠損の正規化

統合処理
- `side` を付与した縦持ち統合
- assets と liabilities の自算値整合チェック、差異のフラグ化
- 地域・産業などセグメント列の正規化（表記ゆれ辞書による `segment_region` 付与）

軽量分析
- 時系列の前年比、CAGR、移動平均
- 差分・増減寄与
- 外れ値検知（IQR, robust Z, 年次差分）とフラグ付与

可視化（ダッシュボード）
- 全体ビュー / 差分ビュー / 構成比ビュー
- ヒートマップ、箱ひげ図、信頼度バンド、注釈モード（外れ値・制度改正年のピン留め）
- 地域／年範囲／side／metric の複合フィルタとハイライト
- 現在ビューに一致した CSV ダウンロード（フィルタ適用済み）

---

## 6. 非機能要件
- パフォーマンス: ローカル処理で実用的応答を確保
- セキュリティ: 既定はローカル完結（外部送信なし）
- 再現性: 入力＋設定ハッシュを保存しビット等価再実行
- 可観測性: `parse_log.json` に詳細記録。エラー時は該当箇所とサンプル行（最大20行）を保持
- アクセシビリティ: 日本語/英語 UI モード、色弱対応パレット
- 文字コード方針: すべて UTF-8（BOM なし）で管理

---

## 7. 除外事項
- 公開統計との自動突合（自動同定・照合の完全自動化）
- 政策的判断を伴う評価の自動化
- 自然言語サマリの常時生成（オンデマンドは任意拡張）

---

## 8. 成功指標（KPI）
- 欠損値処理の自動化率 ≥ 99%
- 整合チェック逸脱率 < 1%（突合可能キーを母数）
- 外れ値検知で主要イベント年（例: 2008, 2020）を ≥ 80% 捕捉
- 同一入力＋設定でハッシュ一致率 100%

---

## 9. 運用・ログ
- `parse_log.json` に処理手順・判定根拠・変換統計を記録
- スキーマ/辞書のバージョン（例: `schema.version`, `era_dict_version`）を明示
- 入力ファイル名、取得日、ハッシュ、ソース URL（可能なら）を保持

---

## 10. 用語対応（参考）
- side: assets = 対外, liabilities = 対内, unknown = 不明
- metric: flow = フロー, reinvested = 再投資収益, net = ネット（原表）, net_computed = ネット（自算）
- value_100m_yen: 億円スケールに正規化した値

---

## 11. ディレクトリ方針（現状）
- `data/` サンプル: `6d-1-1.csv`, `6d-2.csv`
- `docs/` 本書（要件定義）
（今後）`src/`, `notebooks/`, `scripts/`, `tests/` を追加予定

---

## 12. 今後の拡張
- 追加の MOF 統計（他表）対応
- 産業・地域などセグメントの正規辞書化と辞書バージョン管理
- 地域別分析 UI（マルチセレクト、年範囲スライダ、サマリピボット）
- ダッシュボードからの CSV エクスポート（正規化/時系列/構成比/ヒートマップ/箱ひげ統計）
- 描画品質向上（色弱対応パレット、軸/グリッド/ツールチップ刷新、高 DPI 対応）
- CI によるスキーマ検証・変換テスト
- ダッシュボードの共有可能なエクスポート

## 13. 開発ロードマップ（フェーズ案）
- **フェーズ1（MVP）**: 正規化パイプラインの確立、主要ビュー（時系列/前年比差分/構成比/ヒートマップ/箱ひげ図）、`parse_log.json` 詳細化
- **フェーズ2（次期ゴール）**
  - `segment_region` を軸とした地域別分析とフィルタリング
  - 現在ビューに基づく CSV エクスポート API/UI の実装
  - 描画品質改善（スケール調整・ラベル・ホバー・凡例・アニメーション）
- **フェーズ3**: 大規模データ最適化（ダウンサンプリング/キャッシュ/Web Worker）、注釈テンプレート、自動テストと CI
