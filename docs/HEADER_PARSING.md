# ヘッダー解析の改善（2025年10月実装）

## 概要

MOFの投資統計CSVファイル（特に6d-2のような地域別内訳データ）は、複雑な構造を持っています：
- タイトル行・注釈行（行0-15）
- 空行グループ
- 実際のデータヘッダー（行16-23: 多層構造）
- ラベル行（行24-25: 暦年など）
- データ行（行26以降）

この複雑な構造を正しく解析するため、ヘッダー検出ロジックを大幅に改善しました。

## 改善内容

### 1. 注釈行・タイトル行の検出

**新機能**: `is_annotation_row()` および `is_title_row()` 関数

- 注釈マーカー検出: 「（備考）」「(NOTE)」「注:」など
- 番号付き説明文検出: ①、②、(1)、など
- タイトルキーワード検出: 「財務省」「Balance of Payments」など

### 2. 改善されたヘッダー検出ロジック

**関数**: `detect_header_rows()`

**アルゴリズム**:
1. タイトル・注釈行を全てスキップ
2. 最初の連続空行グループを探す
3. 空行グループの直後からヘッダー開始
4. データ開始行を探す:
   - 年表記を含む行（平成、令和、C.Y.など）
   - 数値が50%以上の行
5. ヘッダー開始〜データ開始の直前まで

### 3. 処理結果の改善

#### Before（旧ロジック）
- ヘッダー行数: 1行（誤検出）
- タイトル行をヘッダーとして誤認識
- 地域情報が抽出されない

#### After（新ロジック）
- ヘッダー行数: 26行（正確）
- タイトル・注釈を除外
- 多層ヘッダーを正しく連結
- **41の地域を正しく抽出**

## 検出される地域（6d-2.csvの例）

### 地域グループ（7）
- アジア、北米（該当なし）、中南米（該当なし）、欧州、オセアニア、中東、アフリカ

### 経済グループ（3）
- ASEAN、EU、OECD諸国

### 主要国（31）
中華人民共和国、香港、台湾、韓国、シンガポール、タイ、インドネシア、マレーシア、フィリピン、ベトナム、インド、アメリカ合衆国、カナダ、メキシコ、ブラジル、ケイマン諸島、オーストラリア、ニュージーランド、ドイツ、英国、フランス、オランダ、イタリア、ベルギー、ルクセンブルク、スイス、スウェーデン、スペイン、ロシア、サウジアラビア、アラブ首長国連邦、南アフリカ共和国

### その他（1）
- 合計

## 技術詳細

### ヘッダー連結

多層ヘッダーは「 / 」で連結されます：

```
例: 列10のヘッダー
行18: (空)
行19: (空)
行20: 中華人民共和国
行21: P.R.China
行22: 実行
行23: Execution
行24: Execution
行25: Execution

結果: "中華人民共和国 / P.R.China / 実行 / Execution / Execution / Execution"
```

地域抽出関数 `extract_region_from_header()` がこの連結されたヘッダーから「中華人民共和国」を抽出します。

### 年列の検出

6d-2.csvの年情報は複数列に分散：
- 列0: 和暦（平成26年、令和元年など）
- 列2: 西暦（2014C.Y.、2019C.Y.など）

`identify_year_column()` 関数が列2（2014C.Y.形式）を年列として正しく検出します。

## 今後の課題

1. **他の形式への対応**: 月次データ、四半期データなど
2. **産業別内訳**: 地域と同様に産業情報の抽出
3. **エラーハンドリング**: 予期しない形式への対応

## 関連ファイル

- `src/mof_investviz/normalize.py`: ヘッダー解析ロジック
- `data/dictionaries/regions.yml`: 地域辞書
- `docs/README.md`: 全体要件定義
- `docs/USAGE.md`: 地域別分析の使い方

